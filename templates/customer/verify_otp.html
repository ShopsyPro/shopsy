{% extends "customer/customer_base.html" %}

{% block title %}OTP Verification | ShopsyPro{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<section id="verify-otp" class="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
  <div class="w-full max-w-lg">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-purple-600 to-purple-700 rounded-full mb-6 shadow-lg">
        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
        </svg>
      </div>
      <h1 class="text-4xl font-bold text-white mb-3 bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">Enter Verification Code</h1>
      <p class="text-gray-400 text-lg">We sent a 6-digit code to <span class="text-blue-400 font-semibold">{{ email }}</span></p>
    </div>

    <!-- OTP Input Form -->
    <div class="bg-gray-800/80 backdrop-blur-sm rounded-2xl border border-gray-700/50 p-8 shadow-2xl">
      <form id="verifyOtpForm" class="space-y-6">
        <input type="hidden" id="email" value="{{ email }}">
        
        <div>
          <label for="otp_code" class="block text-lg font-semibold text-gray-200 mb-6 text-center">
            üîê Enter 6-Digit Code
          </label>
          
          <!-- OTP Input Fields -->
          <div class="flex justify-center space-x-4 mb-6">
            <input type="text" maxlength="1" class="otp-input w-14 h-16 text-center text-3xl font-bold bg-gray-700/80 border-2 border-gray-600/50 rounded-xl text-white focus:outline-none focus:ring-4 focus:ring-purple-500/50 focus:border-purple-500 transition-all duration-300 hover:border-gray-500" data-index="0">
            <input type="text" maxlength="1" class="otp-input w-14 h-16 text-center text-3xl font-bold bg-gray-700/80 border-2 border-gray-600/50 rounded-xl text-white focus:outline-none focus:ring-4 focus:ring-purple-500/50 focus:border-purple-500 transition-all duration-300 hover:border-gray-500" data-index="1">
            <input type="text" maxlength="1" class="otp-input w-14 h-16 text-center text-3xl font-bold bg-gray-700/80 border-2 border-gray-600/50 rounded-xl text-white focus:outline-none focus:ring-4 focus:ring-purple-500/50 focus:border-purple-500 transition-all duration-300 hover:border-gray-500" data-index="2">
            <input type="text" maxlength="1" class="otp-input w-14 h-16 text-center text-3xl font-bold bg-gray-700/80 border-2 border-gray-600/50 rounded-xl text-white focus:outline-none focus:ring-4 focus:ring-purple-500/50 focus:border-purple-500 transition-all duration-300 hover:border-gray-500" data-index="3">
            <input type="text" maxlength="1" class="otp-input w-14 h-16 text-center text-3xl font-bold bg-gray-700/80 border-2 border-gray-600/50 rounded-xl text-white focus:outline-none focus:ring-4 focus:ring-purple-500/50 focus:border-purple-500 transition-all duration-300 hover:border-gray-500" data-index="4">
            <input type="text" maxlength="1" class="otp-input w-14 h-16 text-center text-3xl font-bold bg-gray-700/80 border-2 border-gray-600/50 rounded-xl text-white focus:outline-none focus:ring-4 focus:ring-purple-500/50 focus:border-purple-500 transition-all duration-300 hover:border-gray-500" data-index="5">
          </div>
          
          <p class="text-sm text-gray-400 text-center">Enter the code sent to your email</p>
        </div>

        <button type="submit" 
                id="verifyBtn"
                class="w-full py-4 px-6 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-semibold text-lg rounded-xl transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-purple-500/50 transform hover:scale-105 shadow-lg hover:shadow-xl">
          <span class="btn-text">Verify & Access Orders</span>
          <span class="btn-loading hidden">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Verifying...
          </span>
        </button>
      </form>

      <!-- Resend Section -->
      <div class="mt-8 text-center">
        <p class="text-gray-400 text-base mb-4">Didn't receive the code?</p>
        <button id="resendBtn" class="text-blue-400 hover:text-blue-300 text-base font-medium transition-colors hover:underline">
          <span class="resend-text">Resend verification code</span>
          <span class="resend-loading hidden">Sending...</span>
        </button>
      </div>

      <!-- Timer -->
      <div class="mt-4 text-center">
        <p class="text-sm text-gray-500">
          Code expires in: <span id="timer" class="font-mono text-yellow-400 text-lg">--:--</span>
        </p>
      </div>

      <!-- Error Message -->
      <div id="errorMessage" class="hidden mt-6 p-6 bg-red-600/20 border border-red-500/50 rounded-xl">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-base font-semibold text-red-400">Verification Failed</p>
            <p class="text-sm text-red-300 mt-2" id="errorText">Please check your code and try again.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Security Info -->
    <div class="mt-8 text-center">
      <div class="bg-gray-800/60 backdrop-blur-sm rounded-2xl border border-gray-700/50 p-8 shadow-xl">
        <h3 class="text-xl font-bold text-white mb-4">üîí Secure Verification</h3>
        <div class="space-y-3 text-base text-gray-300">
          <p class="flex items-center justify-center gap-2">‚úì Your verification code expires in 2 hours</p>
          <p class="flex items-center justify-center gap-2">‚úì Maximum 5 verification attempts allowed</p>
          <p class="flex items-center justify-center gap-2">‚úì Access session expires after 30 minutes</p>
        </div>
      </div>
    </div>

    <!-- Back Link -->
    <div class="mt-8 text-center">
      <a href="{{ url_for('orders.track_orders') }}" class="inline-flex items-center text-blue-400 hover:text-blue-300 text-base font-medium transition-colors hover:underline">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to Email Entry
      </a>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('verifyOtpForm');
  const emailInput = document.getElementById('email');
  const verifyBtn = document.getElementById('verifyBtn');
  const resendBtn = document.getElementById('resendBtn');
  const btnText = verifyBtn.querySelector('.btn-text');
  const btnLoading = verifyBtn.querySelector('.btn-loading');
  const resendText = resendBtn.querySelector('.resend-text');
  const resendLoading = resendBtn.querySelector('.resend-loading');
  const errorMessage = document.getElementById('errorMessage');
  const errorText = document.getElementById('errorText');
  const timerElement = document.getElementById('timer');
  const otpInputs = document.querySelectorAll('.otp-input');

  // OTP Input Management
  otpInputs.forEach((input, index) => {
    input.addEventListener('input', function(e) {
      // Only allow numbers
      this.value = this.value.replace(/[^0-9]/g, '');
      
      // Move to next input
      if (this.value.length === 1 && index < otpInputs.length - 1) {
        otpInputs[index + 1].focus();
      }
      
      // Auto-submit when all fields are filled
      if (index === otpInputs.length - 1 && this.value.length === 1) {
        checkAutoSubmit();
      }
    });

    input.addEventListener('keydown', function(e) {
      // Move to previous input on backspace
      if (e.key === 'Backspace' && this.value === '' && index > 0) {
        otpInputs[index - 1].focus();
      }
    });

    input.addEventListener('paste', function(e) {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text');
      const pasteValue = paste.replace(/[^0-9]/g, '').slice(0, 6);
      
      // Fill inputs with pasted value
      for (let i = 0; i < pasteValue.length && i < otpInputs.length; i++) {
        otpInputs[i].value = pasteValue[i];
      }
      
      // Focus next empty input or submit if complete
      const nextEmptyIndex = pasteValue.length < otpInputs.length ? pasteValue.length : otpInputs.length - 1;
      otpInputs[nextEmptyIndex].focus();
      
      if (pasteValue.length === 6) {
        checkAutoSubmit();
      }
    });
  });

  function checkAutoSubmit() {
    const code = getOtpCode();
    if (code.length === 6) {
      setTimeout(() => form.dispatchEvent(new Event('submit')), 100);
    }
  }

  function getOtpCode() {
    return Array.from(otpInputs).map(input => input.value).join('');
  }

  function clearOtpInputs() {
    otpInputs.forEach(input => input.value = '');
    otpInputs[0].focus();
  }

  // Timer functionality with database synchronization
  let timeLeft = 7200;
  let lastSync = Date.now();
  
  function updateTimer() {
    const hours = Math.floor(timeLeft / 3600);
    const minutes = Math.floor((timeLeft % 3600) / 60);
    const seconds = timeLeft % 60;
    
    if (hours > 0) {
      timerElement.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
      timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    if (timeLeft <= 0) {
      timerElement.textContent = 'EXPIRED';
      timerElement.classList.add('text-red-400');
      showError('Verification code has expired. Please request a new one.');
    } else {
      timeLeft--;
    }
  }
  
  // Sync with database every 30 seconds to prevent pause issues
  async function syncWithDatabase() {
    const email = emailInput.value;
    try {
      const response = await fetch('/api/track-orders/otp-time-remaining', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
      });
      
      const data = await response.json();
      
      if (data.success) {
        if (data.expired) {
          timeLeft = 0;
          timerElement.textContent = 'EXPIRED';
          timerElement.classList.add('text-red-400');
          showError('Verification code has expired. Please request a new one.');
        } else {
          // Sync the timer with database time
          timeLeft = data.remaining_seconds;
        }
      }
    } catch (error) {
      console.log('Timer sync failed, continuing with local timer');
    }
  }

  // Start timer and sync
  updateTimer();
  const timerInterval = setInterval(updateTimer, 1000);
  
  // Sync with database every 30 seconds
  let syncInterval = setInterval(syncWithDatabase, 30000);
  
  // Initial sync after 5 seconds to get accurate remaining time
  setTimeout(syncWithDatabase, 5000);

  // Form submission
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = emailInput.value;
    const otpCode = getOtpCode();
    
    if (otpCode.length !== 6) {
      showError('Please enter the complete 6-digit code');
      return;
    }

    setLoading(true);
    hideError();

    try {
      const response = await fetch('/api/track-orders/verify-otp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          email: email,
          otp_code: otpCode 
        })
      });

      const data = await response.json();

      if (data.success) {
        // Clear timers
        clearInterval(timerInterval);
        clearInterval(syncInterval);
        
        // Redirect to dashboard
        window.location.href = data.redirect_url;
      } else {
        showError(data.message);
        clearOtpInputs();
      }
    } catch (error) {
      console.error('Error:', error);
      showError('Network error. Please check your connection and try again.');
    } finally {
      setLoading(false);
    }
  });

  // Resend functionality
  resendBtn.addEventListener('click', async function() {
    const email = emailInput.value;
    
    setResendLoading(true);
    hideError();

    try {
      const response = await fetch('/api/track-orders/send-otp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
      });

      const data = await response.json();

      if (data.success) {
        // Reset timer
        timeLeft = 7200;
        timerElement.classList.remove('text-red-400');
        
        // Restart sync timer
        clearInterval(syncInterval);
        syncInterval = setInterval(syncWithDatabase, 30000);
        clearOtpInputs();
        
        // Show success message briefly
        const originalText = resendText.textContent;
        resendText.textContent = 'Code sent!';
        resendText.classList.add('text-green-400');
        
        setTimeout(() => {
          resendText.textContent = originalText;
          resendText.classList.remove('text-green-400');
        }, 3000);
      } else {
        showError(data.message);
      }
    } catch (error) {
      console.error('Error:', error);
      showError('Failed to resend code. Please try again.');
    } finally {
      setResendLoading(false);
    }
  });

  function setLoading(loading) {
    verifyBtn.disabled = loading;
    if (loading) {
      btnText.classList.add('hidden');
      btnLoading.classList.remove('hidden');
    } else {
      btnText.classList.remove('hidden');
      btnLoading.classList.add('hidden');
    }
  }

  function setResendLoading(loading) {
    resendBtn.disabled = loading;
    if (loading) {
      resendText.classList.add('hidden');
      resendLoading.classList.remove('hidden');
    } else {
      resendText.classList.remove('hidden');
      resendLoading.classList.add('hidden');
    }
  }

  function showError(message) {
    errorText.textContent = message;
    errorMessage.classList.remove('hidden');
  }

  function hideError() {
    errorMessage.classList.add('hidden');
  }

  // Focus first input on page load
  otpInputs[0].focus();
  
  // Cleanup intervals when page unloads
  window.addEventListener('beforeunload', function() {
    clearInterval(timerInterval);
    clearInterval(syncInterval);
  });
});
</script>
{% endblock %} 