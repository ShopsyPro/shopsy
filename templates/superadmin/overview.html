{% extends "superadmin/base.html" %}

{% block title %}Overview - Super Admin{% endblock %}

{% block content %}
<section class="min-h-screen p-4 sm:p-6 md:p-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-slate-100">Platform Overview</h1>
        <p class="text-slate-400 mt-1">A high-level look at your platform's performance.</p>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="bg-slate-800/80 p-5 rounded-xl border border-slate-700">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-slate-400">Total Merchants</p>
                    <p class="text-3xl font-bold text-slate-100 mt-1">{{ "{:,}".format(total_shops) }}</p>
                </div>
                <div class="p-3 bg-slate-700/50 rounded-lg"><i class="fas fa-store text-slate-400"></i></div>
            </div>
        </div>
        <div class="bg-slate-800/80 p-5 rounded-xl border border-slate-700">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-slate-400">Total Revenue</p>
                    <p class="text-3xl font-bold text-green-400 mt-1">${{ "{:,.2f}".format(total_revenue) }}</p>
                </div>
                <div class="p-3 bg-green-500/10 rounded-lg"><i class="fas fa-dollar-sign text-green-400"></i></div>
            </div>
        </div>
        <div class="bg-slate-800/80 p-5 rounded-xl border border-slate-700">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-slate-400">Total Orders</p>
                    <p class="text-3xl font-bold text-slate-100 mt-1">{{ "{:,}".format(total_orders) }}</p>
                </div>
                <div class="p-3 bg-slate-700/50 rounded-lg"><i class="fas fa-shopping-cart text-slate-400"></i></div>
            </div>
        </div>
        <div class="bg-slate-800/80 p-5 rounded-xl border border-slate-700">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm text-slate-400">Total Customers</p>
                    <p class="text-3xl font-bold text-slate-100 mt-1">{{ "{:,}".format(total_customers) }}</p>
                </div>
                <div class="p-3 bg-slate-700/50 rounded-lg"><i class="fas fa-users text-slate-400"></i></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="lg:col-span-1 bg-slate-800/80 p-6 rounded-xl border border-slate-700">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">Last 30 Days Growth</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center p-4 bg-slate-700/50 rounded-lg">
                    <p class="text-sm text-slate-300">New Merchants</p>
                    <p class="text-xl font-bold text-blue-400">{{ new_shops_count }}</p>
                </div>
                <div class="flex justify-between items-center p-4 bg-slate-700/50 rounded-lg">
                    <p class="text-sm text-slate-300">New Orders</p>
                    <p class="text-xl font-bold text-blue-400">{{ new_orders_count }}</p>
                </div>
                <div class="flex justify-between items-center p-4 bg-slate-700/50 rounded-lg">
                    <p class="text-sm text-slate-300">Revenue</p>
                    <p class="text-xl font-bold text-green-400">${{ "{:,.2f}".format(recent_revenue) }}</p>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 bg-slate-800/80 p-6 rounded-xl border border-slate-700">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">Top Performing Merchants</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-400">
                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50">
                        <tr>
                            <th scope="col" class="px-4 py-3">Rank</th>
                            <th scope="col" class="px-4 py-3">Merchant</th>
                            <th scope="col" class="px-4 py-3">Revenue</th>
                            <th scope="col" class="px-4 py-3">Orders</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for merchant in top_merchants[:5] %}
                        <tr class="border-b border-slate-700">
                            <td class="px-4 py-3"><span class="bg-blue-600/50 text-blue-200 text-xs font-bold px-2 py-1 rounded-full">{{ loop.index }}</span></td>
                            <td class="px-4 py-3">
                                <p class="font-medium text-slate-200">{{ merchant.shop_name }}</p>
                                <p class="text-xs text-slate-500">@{{ merchant.owner_username }}</p>
                            </td>
                            <td class="px-4 py-3 text-green-400 font-semibold">${{ "{:,.2f}".format(merchant.total_revenue) }}</td>
                            <td class="px-4 py-3">{{ merchant.order_count }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="px-4 py-4 text-center">No merchant data available.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-slate-800/80 p-6 rounded-xl border border-slate-700">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">Recent Orders</h3>
            <table class="w-full text-sm text-left text-slate-400">
                <thead class="text-xs text-slate-400 uppercase bg-slate-700/50">
                    <tr>
                        <th scope="col" class="px-4 py-3">Order ID</th>
                        <th scope="col" class="px-4 py-3">Merchant</th>
                        <th scope="col" class="px-4 py-3">Amount</th>
                        <th scope="col" class="px-4 py-3">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in recent_orders[:5] %}
                    <tr class="border-b border-slate-700">
                        <td class="px-4 py-3 font-mono text-xs">{{ order.order_id }}</td>
                        <td class="px-4 py-3 text-slate-200">{{ order.shop_name }}</td>
                        <td class="px-4 py-3 text-green-400 font-semibold">${{ "{:.2f}".format(order.total_amount) }}</td>
                        <td class="px-4 py-3">
                            {% if order.status == 'completed' %}<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-500/10 text-green-300">Completed</span>
                            {% elif order.status == 'pending' %}<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-500/10 text-yellow-300">Pending</span>
                            {% elif order.status == 'failed' %}<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-500/10 text-red-300">Failed</span>
                            {% else %}<span class="px-2 py-1 text-xs font-medium rounded-full bg-slate-600 text-slate-300">{{ order.status }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="px-4 py-4 text-center">No recent orders found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="bg-slate-800/80 p-6 rounded-xl border border-slate-700">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">Newest Merchants</h3>
            <table class="w-full text-sm text-left text-slate-400">
                <thead class="text-xs text-slate-400 uppercase bg-slate-700/50">
                    <tr>
                        <th scope="col" class="px-4 py-3">Shop Name</th>
                        <th scope="col" class="px-4 py-3">Owner</th>
                        <th scope="col" class="px-4 py-3">Created</th>
                    </tr>
                </thead>
                <tbody>
                    {% for shop in recent_shops[:5] %}
                    <tr class="border-b border-slate-700">
                        <td class="px-4 py-3 font-medium text-slate-200">{{ shop.name }}</td>
                        <td class="px-4 py-3">@{{ shop.owner.username }}</td>
                        <td class="px-4 py-3">{{ shop.created_at.strftime('%b %d, %Y') }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="px-4 py-4 text-center">No recent merchants found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="bg-slate-800/80 p-6 rounded-xl border border-slate-700">
        <h3 class="text-lg font-semibold text-slate-100 mb-4">Real-time Platform Statistics</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            <div>
                <p class="text-2xl font-bold text-slate-100" id="total-shops">{{ "{:,}".format(total_shops) }}</p>
                <p class="text-sm text-slate-400">Total Merchants</p>
            </div>
            <div>
                <p class="text-2xl font-bold text-green-400" id="total-revenue">${{ "{:,.2f}".format(total_revenue) }}</p>
                <p class="text-sm text-slate-400">Total Revenue</p>
            </div>
            <div>
                <p class="text-2xl font-bold text-slate-100" id="online-merchants">-</p>
                <p class="text-sm text-slate-400">Online Merchants</p>
            </div>
            <div>
                <p class="text-2xl font-bold text-slate-100" id="new-orders-24h">-</p>
                <p class="text-sm text-slate-400">New Orders (24h)</p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    let statsUpdateInProgress = false;
    
    function updateStats() {
        if (statsUpdateInProgress) return;
        
        statsUpdateInProgress = true;
        
        fetch('{{ url_for("superadmin.api_stats") }}', {
            headers: { 'Cache-Control': 'no-cache' }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            const updates = [
                ['total-shops', data.total_shops.toLocaleString()],
                ['total-revenue', '$' + data.total_revenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})],
                ['online-merchants', data.online_merchants],
                ['new-orders-24h', data.new_orders_24h]
            ];
            
            requestAnimationFrame(() => {
                updates.forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                });
            });
        })
        .catch(error => {
            console.error('Error fetching stats:', error);
            setTimeout(() => statsUpdateInProgress = false, 5000);
            return;
        })
        .finally(() => {
            statsUpdateInProgress = false;
        });
    }
    
    setInterval(updateStats, 15000);
    updateStats();
</script>
{% endblock %}