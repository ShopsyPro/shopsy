{% extends "_base/base.html" %}

{% block title %}Manage Orders | ShopsyPro{% endblock %}

{% block content %}
<section id="orders" class="min-h-screen p-6 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
  <!-- Header Section -->
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent mb-2">
          Order Management
        </h1>
        <p class="text-gray-400 text-lg">Monitor and manage your customer orders with ease</p>
      </div>
      <div class="flex items-center space-x-4">
        <div
          class="px-4 py-2 bg-gradient-to-r from-blue-600/20 to-purple-600/20 rounded-full border border-blue-500/30">
          <span class="text-blue-300 text-sm font-medium">{{ total_orders }} Total Orders</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Search and Filter Controls -->
  <div class="mb-8">
    <form method="GET" action="/orders"
      class="bg-gradient-to-r from-gray-900/90 to-gray-800/90 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-700/50 p-8 relative overflow-hidden">
      <!-- Decorative background elements -->
      <div class="absolute inset-0 bg-gradient-to-r from-blue-600/5 to-purple-600/5 rounded-3xl"></div>
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>

      <div class="relative mr-6">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-end">
          <!-- Enhanced Search Input -->
          <div class="lg:col-span-6">
            <label for="search_stock" class="block text-sm font-semibold text-gray-300 mb-3 tracking-wide">
              Search Orders
            </label>
            <div class="relative group">
              <input type="text" id="search_stock" name="search_stock" value="{{ search_stock }}"
                placeholder="Search by Order ID, sent stock, or customer..."
                class="w-full h-12 px-5 pr-12 bg-gray-800/80 border border-gray-600/50 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 text-sm group-hover:border-gray-500/70">
              <div class="absolute inset-y-0 right-4 flex items-center
         text-gray-400 transition-colors duration-300
         group-focus-within:text-blue-400">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2 flex items-center">
              <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              e.g. SH-4K2X8-001-A4 or any sent stock content
            </p>
          </div>

          <!-- Enhanced Sort Controls -->
          <div class="lg:col-span-4 flex gap-3 mb-6">
            <div class="flex-1 min-w-[140px]">
              <label for="sort_by" class="block text-sm font-semibold text-gray-300 mb-3 tracking-wide">
                Sort By
              </label>
              <div class="relative">
                <select id="sort_by" name="sort_by"
                  class="appearance-none w-full h-12 px-4 pr-10 bg-gray-800/80 border border-gray-600/50 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 text-sm hover:border-gray-500/70">
                  <option value="date" {% if sort_by=='date' %}selected{% endif %}>Date</option>
                  <option value="total" {% if sort_by=='total' %}selected{% endif %}>Total Amount</option>
                </select>
                <div class="pointer-events-none absolute right-3 top-1/2 transform -translate-y-1/2">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </div>
            </div>

            <div class="flex-1 min-w-[120px]">
              <label for="sort_order" class="block text-sm font-semibold text-gray-300 mb-3 tracking-wide">
                Order
              </label>
              <div class="relative">
                <select id="sort_order" name="sort_order"
                  class="appearance-none w-full h-12 px-4 pr-10 bg-gray-800/80 border border-gray-600/50 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 text-sm hover:border-gray-500/70">
                  <option value="desc" {% if sort_order=='desc' %}selected{% endif %}>Newest First</option>
                  <option value="asc" {% if sort_order=='asc' %}selected{% endif %}>Oldest First</option>
                </select>
                <div class="pointer-events-none absolute right-3 top-1/2 transform -translate-y-1/2">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Enhanced Action Buttons -->
          <div class="lg:col-span-2 flex gap-2 w-full mb-6">
            <button type="submit"
              class="flex-1 h-12 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl shadow-lg transition-all duration-300 flex items-center justify-center gap-2 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 transform hover:scale-105 min-w-[100px]">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <span class="hidden sm:inline">Apply</span>
            </button>
            <a href="/orders"
              class="flex-1 h-12 bg-gray-700/80 hover:bg-gray-600/80 text-white rounded-xl shadow-lg transition-all duration-300 flex items-center justify-center gap-2 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 transform hover:scale-105 min-w-[100px]">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                </path>
              </svg>
              <span class="hidden sm:inline">Reset</span>
            </a>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Enhanced Orders Table -->
  <div
    class="bg-gradient-to-br from-gray-900/95 to-gray-800/95 backdrop-blur-xl rounded-3xl border border-gray-700/50 overflow-hidden shadow-2xl">
    <!-- Table Header -->
    <div class="px-8 py-6 border-b border-gray-700/50 bg-gradient-to-r from-gray-800/50 to-gray-700/50">
      <div class="flex justify-between items-center">
        <div>
          <h3 class="text-xl font-bold text-white flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
              </path>
            </svg>
            All Orders
          </h3>
          <p class="text-gray-400 text-sm mt-1">Complete overview of customer orders</p>
        </div>
        <div class="flex items-center space-x-4">
          <div
            class="px-4 py-2 bg-gradient-to-r from-green-600/20 to-emerald-600/20 rounded-full border border-green-500/30">
            <span class="text-green-300 text-sm font-medium">{{ total_orders }} Records</span>
          </div>
        </div>
      </div>
    </div>

    {% if orders %}
    <div class="overflow-x-auto">
      <table class="w-full min-w-[1200px]">
        <thead>
          <tr
            class="text-gray-300 text-left text-sm bg-gradient-to-r from-gray-800/30 to-gray-700/30 border-b border-gray-700/50">
            <th class="px-6 py-5 font-semibold tracking-wide w-40">Order ID</th>
            <th class="px-6 py-5 font-semibold tracking-wide w-36">Date & Time</th>
            <th class="px-6 py-5 font-semibold tracking-wide w-48">Items</th>
            <th class="px-6 py-5 font-semibold tracking-wide w-48">Sent Stock</th>
            <th class="px-6 py-5 font-semibold tracking-wide w-28">Total</th>
            <th class="px-6 py-5 font-semibold tracking-wide w-28">Discount</th>
            <th class="px-6 py-5 font-semibold tracking-wide w-32">Payment</th>
            <th class="px-6 py-5 font-semibold tracking-wide w-32">Delivery</th>
            <th class="px-6 py-5 font-semibold tracking-wide w-32">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr
            class="border-b border-gray-700/30 hover:bg-gradient-to-r hover:from-gray-800/30 hover:to-gray-700/30 transition-all duration-300 group">
            <td class="px-6 py-5 w-40">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-blue-400 rounded-full flex-shrink-0"></div>
                <div class="font-mono text-white font-semibold text-sm bg-gray-700/50 px-3 py-1 rounded-lg truncate">
                  #{{ order|order_display_id }}
                </div>
              </div>
            </td>
            <td class="px-6 py-5 w-36">
              <div class="text-white font-medium text-sm">{{ order.get('created_at').strftime('%b %d, %Y') }}</div>
              <div class="text-gray-400 text-xs flex items-center gap-1">
                <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {{ order.get('created_at').strftime('%H:%M') }}
              </div>
            </td>
            <td class="px-6 py-5 w-48">
              <div class="text-white">
                {% if order.get('items') %}
                {% set items_list = order.get('items') %}
                {% if items_list|length > 0 %}
                <div class="flex items-center gap-2">
                  <span class="bg-blue-600/20 text-blue-300 px-2 py-1 rounded-full text-xs font-medium flex-shrink-0">
                    {{ items_list[0].get('quantity', 1) }}x
                  </span>
                  <span class="font-medium text-sm truncate">{{ items_list[0].get('name', 'Unknown') }}</span>
                </div>
                {% if items_list|length > 1 %}
                <div class="text-gray-400 text-xs mt-1 flex items-center gap-1">
                  <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  {{ items_list|length - 1 }} more
                </div>
                {% endif %}
                {% else %}
                <span class="text-gray-400 italic text-sm">No items</span>
                {% endif %}
                {% else %}
                <span class="text-gray-400 italic text-sm">No items</span>
                {% endif %}
              </div>
            </td>
            <td class="px-6 py-5 w-48">
              <div class="text-white">
                {% if order.get('sent_stock') and order.get('sent_stock')|length > 0 %}
                {% set sent_items = order.get('sent_stock') %}
                {% if sent_items|length > 0 %}
                <button
                  class="text-left w-full hover:bg-gray-600/50 p-2 rounded-xl transition-all duration-300 stock-modal-trigger group-hover:scale-105"
                  data-order-id="{{ order|order_display_id }}" data-order-object-id="{{ order.get('_id') }}">
                  <div
                    class="font-mono text-xs bg-gradient-to-r from-gray-700 to-gray-800 px-2 py-1 rounded-lg truncate border border-gray-600/50 text-green-300">
                    {{ sent_items[0].get('stock_item', 'N/A') }}
                  </div>
                  {% if sent_items|length > 1 %}
                  <div class="text-gray-400 text-xs mt-1 flex items-center gap-1">
                    <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                      </path>
                    </svg>
                    +{{ sent_items|length - 1 }}
                  </div>
                  {% endif %}
                </button>
                <script type="application/json" id="stock-data-{{ order.get('_id') }}">
                      {{ sent_items|tojson|safe }}
                    </script>
                {% else %}
                <div class="text-gray-400 italic text-sm">No items sent</div>
                {% endif %}
                {% else %}
                <div class="text-gray-400 italic text-sm">No items sent</div>
                {% endif %}
              </div>
            </td>
            <td class="px-6 py-5 w-28">
              <div class="text-white font-bold text-sm">${{ "%.2f"|format(order.get('total_amount', 0)) }}</div>
            </td>
            <td class="px-6 py-5 w-28">
              {% if order.get('discount_total') and order.get('discount_total') > 0 %}
              <div class="text-green-400 font-semibold text-sm">${{ "%.2f"|format(order.get('discount_total')) }}</div>
              {% if order.get('coupon') %}
              <div class="text-gray-400 text-xs bg-gray-700/50 px-2 py-1 rounded mt-1 inline-block truncate">
                {{ order.get('coupon').get('code') }}
              </div>
              {% endif %}
              {% else %}
              <div class="text-gray-400">-</div>
              {% endif %}
            </td>
            <td class="px-6 py-5 w-32">
              <span class="px-2 py-1 text-xs font-semibold rounded-full border whitespace-nowrap
                {% if order.get('status') == 'completed' %}
                  bg-gradient-to-r from-green-500/20 to-emerald-500/20 text-green-300 border-green-500/30
                {% else %}
                  bg-gradient-to-r from-blue-500/20 to-cyan-500/20 text-blue-300 border-blue-500/30
                {% endif %}">
                {% if order.get('status') == 'completed' %}
                ✓ Done
                {% else %}
                ⏳ Pending
                {% endif %}
              </span>
            </td>
            <td class="px-6 py-5 w-32">
              {% if order.get('sent_stock') and order.get('sent_stock')|length > 0 %}
              <span
                class="px-2 py-1 text-xs font-semibold rounded-full bg-gradient-to-r from-green-500/20 to-emerald-500/20 text-green-300 border border-green-500/30 whitespace-nowrap">
                ✓ Delivered
              </span>
              <div class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                </svg>
                {{ order.get('sent_stock')|length }} sent
              </div>
              {% else %}
              <span
                class="px-2 py-1 text-xs font-semibold rounded-full bg-gradient-to-r from-yellow-500/20 to-orange-500/20 text-yellow-300 border border-yellow-500/30 whitespace-nowrap">
                ⏳ Pending
              </span>
              {% endif %}
            </td>
            <td class="px-6 py-5 w-32">
              <a href="{{ url_for('orders.invoice', order_id=order._id) }}" target="_blank"
                class="inline-flex items-center justify-center px-3 py-2 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white text-xs font-semibold rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 w-full">
                <svg class="w-3 h-3 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                  </path>
                </svg>
                <span class="truncate">Invoice</span>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div><!-- This section was already updated in the previous update -->

    <!-- Enhanced Pagination -->
    {% if total_pages > 1 %}
    <div class="px-8 py-6 border-t border-gray-700/50 bg-gradient-to-r from-gray-800/30 to-gray-700/30">
      <div class="flex justify-between items-center">
        <div class="text-sm text-gray-400 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
            </path>
          </svg>
          Showing page <span class="font-semibold text-white">{{ current_page }}</span> of <span
            class="font-semibold text-white">{{ total_pages }}</span>
        </div>
        <div class="flex space-x-3">
          {% if current_page > 1 %}
          <a href="{{ url_for('orders.orders', page=current_page-1, sort_by=sort_by, sort_order=sort_order, search_stock=search_stock) }}"
            class="px-5 py-2 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-white text-sm rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Previous
          </a>
          {% endif %}

          {% if current_page < total_pages %} <a
            href="{{ url_for('orders.orders', page=current_page+1, sort_by=sort_by, sort_order=sort_order, search_stock=search_stock) }}"
            class="px-5 py-2 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-white text-sm rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2">
            Next
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            </a>
            {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    {% else %}
    <div class="p-12 text-center">
      <div class="inline-block p-6 bg-gradient-to-r from-gray-700/50 to-gray-800/50 rounded-full mb-4">
        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
          </path>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-white mb-2">No Orders Found</h3>
      <p class="text-gray-400">Try adjusting your search criteria or check back later.</p>
    </div>
    {% endif %}
  </div>

  <!-- Enhanced Stock Items Modal -->
  <div id="stockModal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-md transition-all duration-300 hidden">
    <div
      class="bg-gradient-to-br from-gray-900/98 to-gray-800/98 backdrop-blur-xl rounded-3xl shadow-2xl max-w-4xl w-full mx-4 flex flex-col border border-gray-700/60 max-h-[90vh]">
      <!-- Modal Header -->
      <div
        class="flex justify-between items-center px-8 py-6 border-b border-gray-700/50 bg-gradient-to-r from-gray-800/50 to-gray-700/50">
        <div>
          <h3 class="text-xl font-bold text-white tracking-tight flex items-center gap-2">
            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
            </svg>
            Sent Stock Items
          </h3>
          <p class="text-gray-400 text-sm mt-1">Detailed view of delivered items</p>
        </div>
        <button id="closeStockModal"
          class="text-gray-400 hover:text-white transition-colors rounded-full p-2 hover:bg-gray-700/50 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="px-8 py-6 overflow-y-auto flex-1">
        <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
              <span class="text-gray-400 text-sm">Order ID:</span>
              <span id="modalOrderId" class="font-mono text-white bg-gray-700/50 px-3 py-1 rounded-lg"></span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-gray-400 text-sm">Total Items:</span>
              <span id="modalItemCount"
                class="font-semibold text-white bg-blue-600/20 px-3 py-1 rounded-lg text-blue-300"></span>
            </div>
          </div>
        </div>

        <div id="modalStockItems" class="space-y-4">
          <!-- Stock items will be populated here -->
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Enhanced sort order labels based on sort_by selection
  document.getElementById('sort_by').addEventListener('change', function () {
    const sortBy = this.value;
    const sortOrder = document.getElementById('sort_order');
    const descOption = sortOrder.querySelector('option[value="desc"]');
    const ascOption = sortOrder.querySelector('option[value="asc"]');

    if (sortBy === 'total') {
      descOption.textContent = 'Highest First';
      ascOption.textContent = 'Lowest First';
    } else {
      descOption.textContent = 'Newest First';
      ascOption.textContent = 'Oldest First';
    }
  });

  // Enhanced Stock Modal Functionality
  document.addEventListener('DOMContentLoaded', function () {
    const stockModal = document.getElementById('stockModal');
    const closeStockModal = document.getElementById('closeStockModal');
    const modalOrderId = document.getElementById('modalOrderId');
    const modalItemCount = document.getElementById('modalItemCount');
    const modalStockItems = document.getElementById('modalStockItems');

    // Open modal when stock button is clicked
    document.querySelectorAll('.stock-modal-trigger').forEach(button => {
      button.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        const orderDisplayId = this.getAttribute('data-order-id');
        const orderObjectId = this.getAttribute('data-order-object-id');
        const stockDataScript = document.getElementById('stock-data-' + orderObjectId);

        if (!stockDataScript) {
          return;
        }

        try {
          const stockItems = JSON.parse(stockDataScript.textContent);

          // Update modal content  
          modalOrderId.textContent = '#' + orderDisplayId;
          modalItemCount.textContent = stockItems.length;

          // Clear and populate stock items
          modalStockItems.innerHTML = '';

          // Add enhanced search functionality within modal
          const searchContainer = document.createElement('div');
          searchContainer.className = 'mb-6';
          searchContainer.innerHTML = `
          <div class="relative">
            <input type="text" id="modalSearch" placeholder="Search within stock items..." 
                   class="w-full px-5 py-3 bg-gray-800/80 border border-gray-600/50 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
            <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
          </div>
        `;
          modalStockItems.appendChild(searchContainer);

          // Create items container
          const itemsContainer = document.createElement('div');
          itemsContainer.className = 'grid gap-4 md:grid-cols-2';
          itemsContainer.id = 'stockItemsContainer';

          stockItems.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'bg-gradient-to-br from-gray-700/80 to-gray-800/80 p-6 rounded-2xl border border-gray-600/50 stock-item-modal hover:border-gray-500/70 transition-all duration-300 transform hover:scale-105';

            const deliveryDate = new Date(item.sent_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

            itemDiv.innerHTML = `
            <div class="flex justify-between items-start mb-4">
              <div>
                <h4 class="font-bold text-white text-lg product-name-modal mb-1">${item.product_name}</h4>
                ${item.duration ? `<div class="text-sm text-gray-400 duration-modal flex items-center gap-1">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Duration: ${item.duration}
                </div>` : ''}
              </div>
              <div class="text-right">
                <span class="inline-flex items-center gap-1 text-xs bg-gradient-to-r from-green-600/20 to-emerald-600/20 text-green-300 px-3 py-1.5 rounded-full border border-green-500/30">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Delivered
                </span>
                <div class="text-xs text-gray-400 mt-1">${deliveryDate}</div>
              </div>
            </div>
            <div class="mb-3">
              <div class="text-sm text-gray-400 mb-2 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                </svg>
                Stock Item:
              </div>
              <div class="relative">
                <div class="font-mono text-sm bg-gradient-to-r from-gray-900/80 to-gray-800/80 text-green-300 p-4 rounded-xl border border-gray-600/50 break-all stock-content-modal relative">
                  ${item.stock_item}
                </div>
                <button class="absolute top-2 right-2 p-2 bg-gray-700/80 hover:bg-gray-600/80 rounded-lg transition-colors copy-btn" 
                        data-stock="${item.stock_item}" 
                        title="Copy to clipboard">
                  <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                </button>
              </div>
            </div>
          `;

            itemsContainer.appendChild(itemDiv);
          });

          modalStockItems.appendChild(itemsContainer);

          // Add copy functionality
          document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', function () {
              const stockItem = this.getAttribute('data-stock');
              navigator.clipboard.writeText(stockItem).then(() => {
                // Show success feedback
                const originalIcon = this.innerHTML;
                this.innerHTML = `
                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              `;
                this.classList.add('bg-green-600/20');

                setTimeout(() => {
                  this.innerHTML = originalIcon;
                  this.classList.remove('bg-green-600/20');
                }, 2000);
              });
            });
          });

          // Add enhanced search functionality
          const modalSearchInput = document.getElementById('modalSearch');
          modalSearchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const stockItems = document.querySelectorAll('.stock-item-modal');
            let visibleCount = 0;

            stockItems.forEach(item => {
              const productName = item.querySelector('.product-name-modal')?.textContent.toLowerCase() || '';
              const stockContent = item.querySelector('.stock-content-modal')?.textContent.toLowerCase() || '';
              const duration = item.querySelector('.duration-modal')?.textContent.toLowerCase() || '';

              if (searchTerm === '' ||
                productName.includes(searchTerm) ||
                stockContent.includes(searchTerm) ||
                duration.includes(searchTerm)) {
                item.style.display = '';
                visibleCount++;
              } else {
                item.style.display = 'none';
              }
            });

            // Update item count
            modalItemCount.textContent = searchTerm ? `${visibleCount} of ${stockItems.length}` : stockItems.length;
          });

          // Show modal with animation
          stockModal.classList.remove('hidden');
          setTimeout(() => {
            stockModal.classList.add('animate-fade-in');
          }, 10);

        } catch (error) {
          console.error('Error parsing stock data:', error);
          return;
        }
      });
    });

    // Close modal functionality
    closeStockModal.addEventListener('click', function () {
      stockModal.classList.add('hidden');
      stockModal.classList.remove('animate-fade-in');
    });

    // Close modal when clicking outside
    stockModal.addEventListener('click', function (e) {
      if (e.target === stockModal) {
        stockModal.classList.add('hidden');
        stockModal.classList.remove('animate-fade-in');
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && !stockModal.classList.contains('hidden')) {
        stockModal.classList.add('hidden');
        stockModal.classList.remove('animate-fade-in');
      }
    });
  });

  // Enhanced animations for cards (if present)
  document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.group');
    cards.forEach((card, index) => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(30px)';
      setTimeout(() => {
        card.style.transition = 'all 0.3s ease-in-out';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, index * 80);
    });
  });

  // Add smooth scrolling and animations
  document.addEventListener('DOMContentLoaded', function () {
    // Animate elements on scroll
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate-fade-in');
        }
      });
    }, observerOptions);

    // Observe table rows
    document.querySelectorAll('tbody tr').forEach(row => {
      observer.observe(row);
    });

    // Dynamic search functionality for orders
    const searchInput = document.getElementById('search_stock');
    const orderRows = document.querySelectorAll('tbody tr');
    const noOrdersMessage = document.getElementById('no-orders-message');
    
    if (searchInput && orderRows.length > 0) {
      // Debounce function to limit search frequency
      let searchTimeout;
      
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const searchTerm = this.value.toLowerCase().trim();
        
        // Show loading state
        orderRows.forEach(row => {
          row.style.opacity = '0.6';
        });
        
        searchTimeout = setTimeout(() => {
          let visibleOrdersCount = 0;
          
          orderRows.forEach(row => {
            const orderId = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
            const orderDate = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
            const orderAmount = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
            const orderStatus = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
            const stockItems = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
            
            if (searchTerm === '' || 
                orderId.includes(searchTerm) || 
                orderDate.includes(searchTerm) ||
                orderAmount.includes(searchTerm) ||
                orderStatus.includes(searchTerm) ||
                stockItems.includes(searchTerm)) {
              row.style.display = '';
              row.style.opacity = '1';
              visibleOrdersCount++;
            } else {
              row.style.display = 'none';
            }
          });
          
          // Show/hide no orders message
          if (visibleOrdersCount === 0 && searchTerm) {
            if (!noOrdersMessage) {
              const messageDiv = document.createElement('div');
              messageDiv.id = 'no-orders-message';
              messageDiv.className = 'text-center py-12';
              messageDiv.innerHTML = `
                <div class="bg-gradient-to-br from-gray-600 to-gray-700 p-6 rounded-2xl w-24 h-24 mx-auto mb-6 flex items-center justify-center">
                  <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
                <h3 class="text-xl font-bold text-white mb-3">No orders match "${searchTerm}"</h3>
                <p class="text-gray-400 max-w-md mx-auto text-sm leading-relaxed">Try a different search term or clear the search to see all orders.</p>
              `;
              const tbody = document.querySelector('tbody');
              if (tbody) {
                tbody.parentNode.insertBefore(messageDiv, tbody.nextSibling);
              }
            } else {
              noOrdersMessage.style.display = 'block';
              noOrdersMessage.querySelector('h3').textContent = `No orders match "${searchTerm}"`;
            }
          } else {
            if (noOrdersMessage) {
              noOrdersMessage.style.display = 'none';
            }
          }
        }, 300); // 300ms debounce
      });
      
      // Handle Enter key to submit search
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const searchTerm = this.value.trim();
          if (searchTerm) {
            // Update URL with search parameter
            const url = new URL(window.location);
            url.searchParams.set('search_stock', searchTerm);
            window.history.pushState({}, '', url);
          }
        }
      });
    }
  });
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }

  /* Custom scrollbar for modal */
  #modalStockItems::-webkit-scrollbar {
    width: 8px;
  }

  #modalStockItems::-webkit-scrollbar-track {
    background: rgba(55, 65, 81, 0.3);
    border-radius: 4px;
  }

  #modalStockItems::-webkit-scrollbar-thumb {
    background: rgba(75, 85, 99, 0.8);
    border-radius: 4px;
  }

  #modalStockItems::-webkit-scrollbar-thumb:hover {
    background: rgba(107, 114, 128, 0.9);
  }

  /* Enhanced hover effects */
  .group:hover .transform {
    transform: translateX(2px);
  }

  /* Smooth transitions for all interactive elements */
  * {
    transition: all 0.3s ease;
  }

  /* Loading states */
  .loading {
    opacity: 0.7;
    pointer-events: none;
  }

  /* Focus states */
  button:focus,
  input:focus,
  select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
  }
</style>
{% endblock %}