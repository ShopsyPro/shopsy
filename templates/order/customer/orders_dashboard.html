{% extends "customer/customer_base.html" %}

{% block title %}Order Dashboard | ShopsyPro{% endblock %}

{% block extra_head %}
{% endblock %}

{% block header_actions %}
<!-- Customer Email -->
<span class="text-blue-400 text-sm hidden sm:block">ðŸ“§ {{ customer_email }}</span>
<!-- Session Status -->
<div id="sessionStatus" class="text-xs text-green-400 hidden">
  âœ“ Verified
</div>
<!-- Logout -->
<a href="{{ url_for('orders.customer_logout') }}" class="text-gray-300 hover:text-white text-sm transition-colors">
  <i class="fas fa-sign-out-alt mr-1"></i>
  <span class="hidden sm:inline">Logout</span>
</a>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold text-white">Your Orders</h1>
    <a href="{{ url_for('orders.customer_orders_dashboard', refresh=1) }}" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors" title="Refresh Orders">
      <i class="fas fa-sync-alt mr-2"></i> Refresh
    </a>
  </div>
  <section id="customer-dashboard" class="min-h-screen p-4 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
  <!-- Header -->
  <div class="mb-6">
    <div class="text-center sm:text-left">
      <h1 class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">My Orders</h1>
      <p class="text-gray-400">All your purchases across ShopsyPro merchants</p>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Total Orders -->
    <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700/50 p-4 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg flex items-center justify-center shadow-md">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
            </svg>
          </div>
        </div>
        <div class="ml-3">
          <p class="text-xs font-medium text-gray-400">Total Orders</p>
          <p class="text-2xl font-bold text-white">{{ stats.total_orders }}</p>
        </div>
      </div>
    </div>

    <!-- Total Spent -->
    <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700/50 p-4 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-10 h-10 bg-gradient-to-r from-green-600 to-green-700 rounded-lg flex items-center justify-center shadow-md">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1">
              </path>
            </svg>
          </div>
        </div>
        <div class="ml-3">
          <p class="text-xs font-medium text-gray-400">Total Spent</p>
          <p class="text-2xl font-bold text-white">${{ "%.2f"|format(stats.total_spent) }}</p>
        </div>
      </div>
    </div>

    <!-- Total Items -->
    <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700/50 p-4 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-10 h-10 bg-gradient-to-r from-purple-600 to-purple-700 rounded-lg flex items-center justify-center shadow-md">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
            </svg>
          </div>
        </div>
        <div class="ml-3">
          <p class="text-xs font-medium text-gray-400">Items Purchased</p>
          <p class="text-2xl font-bold text-white">{{ stats.total_items }}</p>
        </div>
      </div>
    </div>

    <!-- Unique Merchants -->
    <div class="bg-gray-800/80 backdrop-blur-sm rounded-xl border border-gray-700/50 p-4 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-10 h-10 bg-gradient-to-r from-orange-600 to-orange-700 rounded-lg flex items-center justify-center shadow-md">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
              </path>
            </svg>
          </div>
        </div>
        <div class="ml-3">
          <p class="text-xs font-medium text-gray-400">Unique Merchants</p>
          <p class="text-2xl font-bold text-white">{{ stats.unique_merchants }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders List -->
  <div class="bg-gray-800/80 backdrop-blur-sm rounded-2xl border border-gray-700/50 overflow-hidden shadow-xl">
    <div class="p-6 border-b border-gray-700/50">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div class="flex-1">
          <h3 class="text-xl font-bold text-white mb-2">Order History</h3>
          <div class="text-base text-gray-400">
            Total: <span class="font-semibold text-white">{{ total_orders }}</span> orders
          </div>
        </div>
        <div class="w-full sm:w-80">
          <div class="relative">
            <input type="text" id="customerOrdersSearch" placeholder="Search orders by ID, shop, or status..."
                   class="w-full px-4 py-2 pl-10 bg-gray-700/80 border border-gray-600/50 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 text-sm">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>

    {% if orders %}
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="text-gray-300 text-left text-base border-b border-gray-700/50 bg-gray-800/50">
            <th class="px-6 py-4 font-semibold">Order</th>
            <th class="px-6 py-4 font-semibold">Merchant</th>
            <th class="px-6 py-4 font-semibold">Date</th>
            <th class="px-6 py-4 font-semibold">Items</th>
            <th class="px-6 py-4 font-semibold">Sent Stock</th>
            <th class="px-6 py-4 font-semibold">Delivered</th>
            <th class="px-6 py-4 font-semibold">Total</th>
            <th class="px-6 py-4 font-semibold">Invoice</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr class="border-b border-gray-700/30 hover:bg-gray-700/30 transition-all duration-300">
            <!-- Order ID -->
            <td class="px-6 py-4">
              <div class="flex flex-col">
                <div class="text-white font-medium">#{{ order.get('order_summary', {}).get('display_id', 'N/A') }}</div>
                <div class="text-xs text-gray-400 mt-1">{{ order.get('order_summary', {}).get('short_display_id', 'N/A')
                  }}</div>
              </div>
            </td>

            <!-- Merchant -->
            <td class="px-6 py-4">
              <div class="flex flex-col">
                <div class="text-white font-medium">{{ order.get('shop_name', 'Unknown Shop') }}</div>
                <a href="/{{ order.get('shop_username', 'unknown') }}" target="_blank"
                  class="text-xs text-blue-400 hover:text-blue-300 transition-colors">
                  @{{ order.get('shop_username', 'unknown') }}
                </a>
              </div>
            </td>

            <!-- Date -->
            <td class="px-6 py-4">
              <div class="text-white">{{ order.get('created_at').strftime('%b %d, %Y') if order.get('created_at') else
                'N/A' }}</div>
              <div class="text-gray-400 text-xs">{{ order.get('created_at').strftime('%H:%M') if order.get('created_at')
                else 'N/A' }}</div>
            </td>

            <!-- Items -->
            <td class="px-6 py-4">
              <div class="text-white">
                {% set order_items = order.get('items', []) %}
                {% if order_items and order_items|length > 0 %}
                {% set first_item = order_items[0] %}
                {{ first_item.get('quantity', 1) }}x {{ first_item.get('name', 'Unknown Item') }}
                {% if order_items|length > 1 %}
                <div class="text-gray-400 text-xs mt-1">+{{ order_items|length - 1 }} more</div>
                {% endif %}
                {% else %}
                <span class="text-gray-400">No items</span>
                {% endif %}
              </div>
            </td>

            <td class="px-4 py-5 w-40">
              <div class="text-white">
                {% if order.get('sent_stock') and order.get('sent_stock')|length > 0 %}
                {% set sent_items = order.get('sent_stock') %}
                {% if sent_items|length > 0 %}
                <button
                  class="text-left w-full hover:bg-gray-600/50 p-2 rounded-xl transition-all duration-300 stock-modal-trigger group-hover:scale-105"
                  data-order-id="{{ order|order_display_id }}" data-order-object-id="{{ order.get('_id') }}">
                  <div
                    class="font-mono text-xs bg-gradient-to-r from-gray-700 to-gray-800 px-2 py-1 rounded-lg truncate border border-gray-600/50 text-green-300">
                    {{ sent_items[0].get('stock_item', 'N/A') }}
                  </div>
                  {% if sent_items|length > 1 %}
                  <div class="text-gray-400 text-xs mt-1 flex items-center gap-1">
                    <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                      </path>
                    </svg>
                    +{{ sent_items|length - 1 }}
                  </div>
                  {% endif %}
                </button>
                <script type="application/json" id="stock-data-{{ order.get('_id') }}">
                      {{ sent_items|tojson|safe }}
                    </script>
                {% else %}
                <div class="ms-2 text-gray-400 italic text-sm">No items sent</div>
                {% endif %}
                {% else %}
                <div class="ms-2 text-gray-400 italic text-sm">No items sent</div>
                {% endif %}
              </div>
            </td>

            <!-- Delivered Status -->
            <td class="px-6 py-4">
              {% set sent_stock = order.get('sent_stock', []) %}
              {% if sent_stock and sent_stock|length > 0 %}
              <div class="flex items-center">
                <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                <span class="text-green-400 text-sm font-medium">{{ sent_stock|length }} items</span>
              </div>

              <!-- Hidden delivery data -->
              <script type="application/json" id="delivery-data-{{ order.get('_id') }}">
                  {{ sent_stock|tojson|safe }}
                </script>
              {% else %}
              <div class="flex items-center">
                <div class="w-2 h-2 bg-yellow-400 rounded-full mr-2"></div>
                <span class="text-yellow-400 text-sm">Pending</span>
              </div>
              {% endif %}
            </td>

            <!-- Total -->
            <td class="px-6 py-4">
              <div class="text-white font-medium">${{ "%.2f"|format(order.get('total_amount', 0)) }}</div>
              {% if order.get('discount_total') and order.get('discount_total') > 0 %}
              <div class="text-green-400 text-xs">-${{ "%.2f"|format(order.get('discount_total', 0)) }} saved</div>
              {% endif %}
            </td>

            <!-- â€¦ invoice â€¦ -->
            <td class="px-6 py-4 w-32">
              <div class="flex flex-col space-y-2">
                <!-- Customer Invoice Button -->
                <a href="{{ url_for('orders.customer_invoice', order_id=order.get('_id')) }}" target="_blank" class="inline-flex items-center justify-center px-3 py-2
              bg-gradient-to-r from-purple-600 to-purple-700
              hover:from-purple-700 hover:to-purple-800
              text-white text-xs font-semibold rounded-xl
              transition-all duration-300 shadow-lg hover:shadow-xl
              transform hover:scale-105 w-full" title="Download Invoice PDF">
                  <svg class="w-3 h-3 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 
                 012-2h5.586a1 1 0 01.707.293l5.414 
                 5.414a1 1 0 01.293.707V19a2 2 0 
                 01-2 2z" />
                  </svg>
                  <span class="truncate">Invoice</span>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="px-6 py-4 border-t border-gray-700/30 flex justify-between items-center">
      <div class="text-sm text-gray-400">
        Showing page {{ current_page }} of {{ total_pages }}
      </div>
      <div class="flex space-x-2">
        {% if current_page > 1 %}
        <a href="{{ url_for('orders.customer_orders_dashboard', page=current_page-1) }}"
          class="px-4 py-2 bg-gray-700 text-white text-sm rounded-md hover:bg-gray-600 transition-colors">
          Previous
        </a>
        {% endif %}

        {% if current_page < total_pages %} <a
          href="{{ url_for('orders.customer_orders_dashboard', page=current_page+1) }}"
          class="px-4 py-2 bg-gray-700 text-white text-sm rounded-md hover:bg-gray-600 transition-colors">
          Next
          </a>
          {% endif %}
      </div>
    </div>
    {% endif %}

    {% else %}
    <div class="p-8 text-center">
      <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
        </svg>
      </div>
      <p class="text-gray-400 text-lg">No orders found</p>
      <p class="text-gray-500 text-sm mt-2">You haven't made any purchases yet</p>
    </div>
    {% endif %}
  </div>

  <!-- Delivery Details Modal -->
  <div id="deliveryModal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm transition-all duration-300 hidden">
    <div class="bg-gray-900/95 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 flex flex-col border border-gray-700/60">
      <div class="flex justify-between items-center px-6 py-4 border-b border-gray-700/40">
        <h3 class="text-lg font-semibold text-white tracking-tight">Delivered Items</h3>
        <button id="closeDeliveryModal"
          class="text-gray-400 hover:text-white transition-colors rounded-full p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="px-6 py-4 overflow-y-auto flex-1">
        <div class="mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div>
            <p class="text-gray-400 text-sm mb-1">Order: <span id="modalOrderId" class="font-mono text-white"></span>
            </p>
            <p class="text-gray-400 text-sm">Delivered Items: <span id="modalItemCount"
                class="font-semibold text-white"></span></p>
          </div>
        </div>
        <div id="modalDeliveryItems" class="space-y-4">
          <!-- Delivery items will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Stock Items Modal -->
  <div id="stockModal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-md transition-all duration-300 hidden">
    <div
      class="bg-gradient-to-br from-gray-900/95 to-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl max-w-4xl w-full mx-4 flex flex-col border border-gray-700/60 max-h-[90vh]">
      <!-- Modal Header -->
      <div
        class="flex justify-between items-center px-8 py-6 border-b border-gray-700/50 bg-gradient-to-r from-gray-800/50 to-gray-700/50">
        <div>
          <h3 class="text-xl font-bold text-white tracking-tight flex items-center gap-2">
            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
            </svg>
            Sent Stock Items
          </h3>
          <p class="text-gray-400 text-sm mt-1">Detailed view of delivered items</p>
        </div>
        <button id="closeStockModal"
          class="text-gray-400 hover:text-white transition-colors rounded-full p-2 hover:bg-gray-700/50 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="px-8 py-6 overflow-y-auto flex-1">
        <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
              <span class="text-gray-400 text-sm">Order ID:</span>
              <span id="stockModalOrderId" class="font-mono text-white bg-gray-700/50 px-3 py-1 rounded-lg"></span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-gray-400 text-sm">Total Items:</span>
              <span id="stockModalItemCount"
                class="font-semibold text-white bg-blue-600/20 px-3 py-1 rounded-lg text-blue-300"></span>
            </div>
          </div>
        </div>

        <div id="modalStockItems" class="space-y-4">
          <!-- Stock items will be populated here -->
        </div>
      </div>
    </div>
  </div>
</section>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const stockModal = document.getElementById('stockModal');
    const closeStockModal = document.getElementById('closeStockModal');
    const stockModalOrderId = document.getElementById('stockModalOrderId');
    const stockModalItemCount = document.getElementById('stockModalItemCount');
    const modalStockItems = document.getElementById('modalStockItems');

    // Open modal when stock button is clicked
    document.querySelectorAll('.stock-modal-trigger').forEach(button => {
      button.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        const orderDisplayId = this.getAttribute('data-order-id');
        const orderObjectId = this.getAttribute('data-order-object-id');
        const stockDataScript = document.getElementById('stock-data-' + orderObjectId);

        if (!stockDataScript) {
          return;
        }

        try {
          const stockItems = JSON.parse(stockDataScript.textContent);

          // Update modal content  
          stockModalOrderId.textContent = '#' + orderDisplayId;
          stockModalItemCount.textContent = stockItems.length;

          // Clear and populate stock items
          modalStockItems.innerHTML = '';

          // Add enhanced search functionality within modal
          const searchContainer = document.createElement('div');
          searchContainer.className = 'mb-6';
          searchContainer.innerHTML = `
          <div class="relative">
            <input type="text" id="modalSearch" placeholder="Search within stock items..." 
                   class="w-full px-5 py-3 bg-gray-800/80 border border-gray-600/50 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
            <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
          </div>
        `;
          modalStockItems.appendChild(searchContainer);

          // Create items container
          const itemsContainer = document.createElement('div');
          itemsContainer.className = 'grid gap-4 md:grid-cols-2';
          itemsContainer.id = 'stockItemsContainer';

          stockItems.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'bg-gradient-to-br from-gray-700/80 to-gray-800/80 p-6 rounded-2xl border border-gray-600/50 stock-item-modal hover:border-gray-500/70 transition-all duration-300 transform hover:scale-105';

            const deliveryDate = new Date(item.sent_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

            itemDiv.innerHTML = `
            <div class="flex justify-between items-start mb-4">
              <div>
                <h4 class="font-bold text-white text-lg product-name-modal mb-1">${item.product_name}</h4>
                ${item.duration ? `<div class="text-sm text-gray-400 duration-modal flex items-center gap-1">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Duration: ${item.duration}
                </div>` : ''}
              </div>
              <div class="text-right">
                <span class="inline-flex items-center gap-1 text-xs bg-gradient-to-r from-green-600/20 to-emerald-600/20 text-green-300 px-3 py-1.5 rounded-full border border-green-500/30">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Delivered
                </span>
                <div class="text-xs text-gray-400 mt-1">${deliveryDate}</div>
              </div>
            </div>
            <div class="mb-3">
              <div class="text-sm text-gray-400 mb-2 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                </svg>
                Stock Item:
              </div>
              <div class="relative">
                <div class="font-mono text-sm bg-gradient-to-r from-gray-900/80 to-gray-800/80 text-green-300 p-4 rounded-xl border border-gray-600/50 break-all stock-content-modal relative">
                  ${item.stock_item}
                </div>
                <button class="absolute top-2 right-2 p-2 bg-gray-700/80 hover:bg-gray-600/80 rounded-lg transition-colors copy-btn" 
                        data-stock="${item.stock_item}" 
                        title="Copy to clipboard">
                  <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                </button>
              </div>
            </div>
          `;

            itemsContainer.appendChild(itemDiv);
          });

          modalStockItems.appendChild(itemsContainer);

          // Add copy functionality
          document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', function () {
              const stockItem = this.getAttribute('data-stock');
              navigator.clipboard.writeText(stockItem).then(() => {
                // Show success feedback
                const originalIcon = this.innerHTML;
                this.innerHTML = `
                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              `;
                this.classList.add('bg-green-600/20');

                setTimeout(() => {
                  this.innerHTML = originalIcon;
                  this.classList.remove('bg-green-600/20');
                }, 2000);
              });
            });
          });

          // Add enhanced search functionality
          const modalSearchInput = document.getElementById('modalSearch');
          modalSearchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const stockItems = document.querySelectorAll('.stock-item-modal');
            let visibleCount = 0;

            stockItems.forEach(item => {
              const productName = item.querySelector('.product-name-modal')?.textContent.toLowerCase() || '';
              const stockContent = item.querySelector('.stock-content-modal')?.textContent.toLowerCase() || '';
              const duration = item.querySelector('.duration-modal')?.textContent.toLowerCase() || '';

              if (searchTerm === '' ||
                productName.includes(searchTerm) ||
                stockContent.includes(searchTerm) ||
                duration.includes(searchTerm)) {
                item.style.display = '';
                visibleCount++;
              } else {
                item.style.display = 'none';
              }
            });

            // Update item count
            modalItemCount.textContent = searchTerm ? `${visibleCount} of ${stockItems.length}` : stockItems.length;
          });

          // Show modal with animation
          stockModal.classList.remove('hidden');
          setTimeout(() => {
            stockModal.classList.add('animate-fade-in');
          }, 10);

        } catch (error) {
          console.error('Error parsing stock data:', error);
          return;
        }
      });
    });

    // Close modal functionality
    closeStockModal.addEventListener('click', function () {
      stockModal.classList.add('hidden');
      stockModal.classList.remove('animate-fade-in');
    });

    // Close modal when clicking outside
    stockModal.addEventListener('click', function (e) {
      if (e.target === stockModal) {
        stockModal.classList.add('hidden');
        stockModal.classList.remove('animate-fade-in');
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && !stockModal.classList.contains('hidden')) {
        stockModal.classList.add('hidden');
        stockModal.classList.remove('animate-fade-in');
      }
    });
  });

  // Add smooth scrolling and animations
  document.addEventListener('DOMContentLoaded', function () {
    // Animate elements on scroll
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate-fade-in');
        }
      });
    }, observerOptions);

    // Observe table rows
    document.querySelectorAll('tbody tr').forEach(row => {
      observer.observe(row);
    });

    // Session management
    let sessionTimer;
    let warningShown = false;

    function startSessionTimer() {
      // Show warning at 25 minutes, expire at 30 minutes
      sessionTimer = setTimeout(() => {
        if (!warningShown) {
          warningShown = true;
          if (confirm('Your session will expire in 5 minutes for security. Would you like to extend it?')) {
            extendSession();
          }
        }
      }, 25 * 60 * 1000); // 25 minutes
    }

    function extendSession() {
      fetch('/api/track-orders/extend-session', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            warningShown = false;
            clearTimeout(sessionTimer);
            startSessionTimer();

            // Show session status briefly
            const status = document.getElementById('sessionStatus');
            status.classList.remove('hidden');
            status.textContent = 'âœ“ Session Extended';
            setTimeout(() => {
              status.textContent = 'âœ“ Verified';
            }, 3000);
          } else {
            alert('Session expired. Redirecting to verification...');
            window.location.href = '/track-orders';
          }
        })
        .catch(error => {
          console.error('Error extending session:', error);
        });
    }

    // Start session timer
    startSessionTimer();
    document.getElementById('sessionStatus').classList.remove('hidden');

    // Delivery Modal Management
    const deliveryModal = document.getElementById('deliveryModal');
    const closeDeliveryModal = document.getElementById('closeDeliveryModal');
    const modalOrderId = document.getElementById('modalOrderId');
    const modalItemCount = document.getElementById('modalItemCount');
    const modalDeliveryItems = document.getElementById('modalDeliveryItems');
    const modalSearch = document.getElementById('modalSearch');

    // Open delivery modal
    document.querySelectorAll('.view-delivery-btn').forEach(button => {
      button.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        const orderDisplayId = this.getAttribute('data-order-id');
        const orderObjectId = this.getAttribute('data-order-object-id');
        const deliveryDataScript = document.getElementById('delivery-data-' + orderObjectId);

        if (!deliveryDataScript) {
          return;
        }

        try {
          const deliveryItems = JSON.parse(deliveryDataScript.textContent);

          // Update modal content
          modalOrderId.textContent = '#' + orderDisplayId;
          modalItemCount.textContent = deliveryItems.length;

          // Clear and populate delivery items
          modalDeliveryItems.innerHTML = '';

          deliveryItems.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'bg-gray-700 p-4 rounded-lg border border-gray-600 delivery-item';

            const deliveryDate = item.sent_at ? new Date(item.sent_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            }) : 'Unknown';

            itemDiv.innerHTML = `
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-semibold text-white product-name">${item.product_name || 'Product'}</h4>
              <span class="text-xs bg-green-600 text-white px-2 py-1 rounded-full">
                Delivered: ${deliveryDate}
              </span>
            </div>
            ${item.duration ? `<div class="text-sm text-gray-400 mb-2 duration-text">Duration: ${item.duration}</div>` : ''}
            <div class="text-sm text-gray-400 mb-2">Content:</div>
            <div class="font-mono text-sm bg-gray-900 text-green-400 p-3 rounded border border-gray-600 break-all delivery-content">
              ${item.stock_item || 'N/A'}
            </div>
          `;

            modalDeliveryItems.appendChild(itemDiv);
          });

          // Reset search
          modalSearch.value = '';

          // Show modal
          deliveryModal.classList.remove('hidden');
        } catch (error) {
          console.error('Error parsing delivery data:', error);
        }
      });
    });

    // Close modal
    closeDeliveryModal.addEventListener('click', function () {
      deliveryModal.classList.add('hidden');
    });

    // Close modal when clicking outside
    deliveryModal.addEventListener('click', function (e) {
      if (e.target === deliveryModal) {
        deliveryModal.classList.add('hidden');
      }
    });

    // Modal search functionality
    modalSearch.addEventListener('input', function () {
      const searchTerm = this.value.toLowerCase();
      const deliveryItems = modalDeliveryItems.querySelectorAll('.delivery-item');
      let visibleCount = 0;

      deliveryItems.forEach(item => {
        const productName = item.querySelector('.product-name')?.textContent.toLowerCase() || '';
        const deliveryContent = item.querySelector('.delivery-content')?.textContent.toLowerCase() || '';
        const duration = item.querySelector('.duration-text')?.textContent.toLowerCase() || '';

        if (searchTerm === '' ||
          productName.includes(searchTerm) ||
          deliveryContent.includes(searchTerm) ||
          duration.includes(searchTerm)) {
          item.style.display = '';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });

      // Update item count
      modalItemCount.textContent = searchTerm ? `${visibleCount} of ${deliveryItems.length}` : deliveryItems.length;
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && !deliveryModal.classList.contains('hidden')) {
        deliveryModal.classList.add('hidden');
      }
    });
  });

  // Dynamic search functionality for customer orders
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('customerOrdersSearch');
    const orderCards = document.querySelectorAll('.order-card');
    const noOrdersMessage = document.getElementById('no-orders-message');
    
    if (searchInput && orderCards.length > 0) {
      // Debounce function to limit search frequency
      let searchTimeout;
      
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const searchTerm = this.value.toLowerCase().trim();
        
        // Show loading state
        orderCards.forEach(card => {
          card.style.opacity = '0.6';
        });
        
        searchTimeout = setTimeout(() => {
          let visibleOrdersCount = 0;
          
          orderCards.forEach(card => {
            const orderId = card.querySelector('.order-id')?.textContent.toLowerCase() || '';
            const shopName = card.querySelector('.shop-name')?.textContent.toLowerCase() || '';
            const orderStatus = card.querySelector('.order-status')?.textContent.toLowerCase() || '';
            const orderAmount = card.querySelector('.order-amount')?.textContent.toLowerCase() || '';
            const orderDate = card.querySelector('.order-date')?.textContent.toLowerCase() || '';
            
            if (searchTerm === '' || 
                orderId.includes(searchTerm) || 
                shopName.includes(searchTerm) ||
                orderStatus.includes(searchTerm) ||
                orderAmount.includes(searchTerm) ||
                orderDate.includes(searchTerm)) {
              card.style.display = '';
              card.style.opacity = '1';
              visibleOrdersCount++;
            } else {
              card.style.display = 'none';
            }
          });
          
          // Show/hide no orders message
          if (visibleOrdersCount === 0 && searchTerm) {
            if (!noOrdersMessage) {
              const messageDiv = document.createElement('div');
              messageDiv.id = 'no-orders-message';
              messageDiv.className = 'text-center py-12';
              messageDiv.innerHTML = `
                <div class="bg-gradient-to-br from-gray-600 to-gray-700 p-6 rounded-2xl w-24 h-24 mx-auto mb-6 flex items-center justify-center">
                  <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
                <h3 class="text-xl font-bold text-white mb-3">No orders match "${searchTerm}"</h3>
                <p class="text-gray-400 max-w-md mx-auto text-sm leading-relaxed">Try a different search term or clear the search to see all orders.</p>
              `;
              const ordersContainer = document.querySelector('.orders-container');
              if (ordersContainer) {
                ordersContainer.appendChild(messageDiv);
              }
            } else {
              noOrdersMessage.style.display = 'block';
              noOrdersMessage.querySelector('h3').textContent = `No orders match "${searchTerm}"`;
            }
          } else {
            if (noOrdersMessage) {
              noOrdersMessage.style.display = 'none';
            }
          }
        }, 300); // 300ms debounce
      });
      
      // Handle Enter key to submit search
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const searchTerm = this.value.trim();
          if (searchTerm) {
            // Update URL with search parameter
            const url = new URL(window.location);
            url.searchParams.set('search', searchTerm);
            window.history.pushState({}, '', url);
          }
        }
      });
    }
  });
</script>



<!-- Order Data for JavaScript -->
<script type="application/json" id="ordersData">
  {% if all_orders %}
    {% set orders_json = all_orders|tojson|safe %}
    {{ orders_json if orders_json != 'null' else '[]' }}
  {% else %}
    []
  {% endif %}
</script>
        </form>
      </div>
    </div>
  </div>
</div>



<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }

  /* Custom scrollbar for modal */
  #modalStockItems::-webkit-scrollbar {
    width: 8px;
  }

  #modalStockItems::-webkit-scrollbar-track {
    background: rgba(55, 65, 81, 0.3);
    border-radius: 4px;
  }

  #modalStockItems::-webkit-scrollbar-thumb {
    background: rgba(75, 85, 99, 0.8);
    border-radius: 4px;
  }

  #modalStockItems::-webkit-scrollbar-thumb:hover {
    background: rgba(107, 114, 128, 0.9);
  }

  /* Enhanced hover effects */
  .group:hover .transform {
    transform: translateX(2px);
  }

  /* Smooth transitions for all interactive elements */
  * {
    transition: all 0.3s ease;
  }

  /* Loading states */
  .loading {
    opacity: 0.7;
    pointer-events: none;
  }

  /* Focus states */
  button:focus,
  input:focus,
  select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
  }
</style>
{% endblock %}